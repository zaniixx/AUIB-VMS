{% extends 'base.html' %}
{% import '_macros.html' as ui %}

{% block title %}System Settings - Admin{% endblock %}

{% block body %}
<div class="container" style="padding-top: var(--space-6); padding-bottom: var(--space-6);">
  
  <!-- Page Header -->
  <div style="margin-bottom: var(--space-6);">
    <h1 class="text-3xl" style="margin-bottom: var(--space-2);">System Settings</h1>
    <p class="text-muted">Configure email settings and system preferences.</p>
  </div>

  <!-- Email Settings Form -->
  <div class="card" style="margin-bottom: var(--space-8);">
    <div class="card__header">
      <h2 class="text-xl font-semibold">Email Configuration</h2>
      <p class="text-sm text-muted">SMTP settings for sending system emails and notifications.</p>
      
      <!-- Quick Setup Guide -->
      <div class="alert alert-info" style="margin-top: var(--space-4);">
        <h4 class="font-medium" style="margin-bottom: var(--space-2);">Quick Setup for Gmail/Outlook</h4>

        <div style="font-size: var(--text-sm);">
          <p><strong>Gmail:</strong> Use smtp.gmail.com:587 with TLS. Enable 2FA and create an <a href="https://support.google.com/accounts/answer/185833" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">App Password</a> instead of your regular password.</p>
          <p><strong>Outlook:</strong> Use smtp-mail.outlook.com:587 with TLS. Use your Outlook password or create an <a href="https://support.microsoft.com/en-us/account-billing/using-app-passwords-with-apps-that-don-t-support-two-step-verification-5896ed9b-4263-e681-128a-a6f2979a7944" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">App Password</a> if 2FA is enabled.</p>
        </div>
        
        <!-- Preset Configuration Buttons -->
        <div style="margin-top: var(--space-4); display: flex; gap: var(--space-3); flex-wrap: wrap;">
          <button type="button" onclick="setGmailConfig()" class="btn btn-secondary btn-sm">
            ðŸ“§ Configure for Gmail
          </button>
          <button type="button" onclick="setOutlookConfig()" class="btn btn-secondary btn-sm">
            ðŸ“§ Configure for Outlook
          </button>
        </div>
      </div>
    </div>
    <div class="card__body">
      <form method="post" action="{{ url_for('admin.settings') }}" data-validate>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4);">
          
          {{ ui.form_input(
            label='SMTP Host',
            name='smtp_host',
            type='text',
            placeholder='smtp.gmail.com',
            value=cfg.SMTP_HOST or '',
            help_text='SMTP server hostname or IP address'
          ) }}
          
          {{ ui.form_input(
            label='SMTP Port',
            name='smtp_port',
            type='number',
            placeholder='587',
            value=cfg.SMTP_PORT or '',
            help_text='SMTP server port (587 for TLS, 465 for SSL, 25 for plain)'
          ) }}
          
          {{ ui.form_input(
            label='SMTP Username',
            name='smtp_user',
            type='email',
            placeholder='your-email@gmail.com',
            value=cfg.SMTP_USER or '',
            help_text='Email account username for authentication'
          ) }}
          
          {{ ui.form_input(
            label='SMTP Password',
            name='smtp_pass',
            type='password',
            value=cfg.SMTP_PASS or '',
            help_text='Email account password or App Password (required for Gmail/Outlook with 2FA)'
          ) }}
          
          {{ ui.form_input(
            label='Default Sender Email',
            name='mail_default_sender',
            type='email',
            placeholder='noreply@auib.edu',
            value=cfg.MAIL_DEFAULT_SENDER or '',
            help_text='Email address that appears as the sender'
          ) }}
          
        </div>

        <!-- Security Options -->
        <div style="margin-top: var(--space-6);">
          <h3 class="text-lg font-medium" style="margin-bottom: var(--space-4);">Security Options</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4);">
            
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" name="smtp_use_tls" value="1" {% if cfg.SMTP_USE_TLS == '1' %}checked{% endif %} style="margin-right: var(--space-2);">
                Use TLS Encryption
              </label>
              <div class="form-help">Enable TLS encryption (recommended for port 587)</div>
            </div>
            
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" name="smtp_use_ssl" value="1" {% if cfg.SMTP_USE_SSL == '1' %}checked{% endif %} style="margin-right: var(--space-2);">
                Use SSL Encryption
              </label>
              <div class="form-help">Enable SSL encryption (recommended for port 465)</div>
            </div>
            
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" name="smtp_skip_auth" value="1" {% if cfg.SMTP_SKIP_AUTH == '1' %}checked{% endif %} style="margin-right: var(--space-2);">
                Skip Authentication
              </label>
              <div class="form-help">Skip SMTP authentication (for local servers that don't require login)</div>
            </div>
            
          </div>
        </div>

        <!-- Save Button -->
        <div style="margin-top: var(--space-6);">
          {{ ui.button('Save Settings', variant='primary', type='submit') }}
        </div>
        
      </form>
    </div>
  </div>

  <!-- Test Email Section -->
  <div class="card">
    <div class="card__header">
      <h2 class="text-xl font-semibold">Send Test Email</h2>
      <p class="text-sm text-muted">Verify your email configuration by sending a test message.</p>
    </div>
    <div class="card__body">
      <form method="post" action="{{ url_for('admin.test_mail') }}" data-validate>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4);">
          
          {{ ui.form_input(
            label='Recipient Email',
            name='to',
            type='email',
            value=current_user.email,
            placeholder='test@example.com',
            help_text='Email address to send the test to'
          ) }}
          
          {{ ui.form_input(
            label='Subject',
            name='subject',
            type='text',
            value='VMS Test Email',
            placeholder='Test Subject',
            help_text='Subject line for the test email'
          ) }}
          
        </div>
        
        {{ ui.form_textarea(
          label='Message Body',
          name='body',
          rows=4,
          value='This is a test email from the AUIB Volunteer Management System. If you received this, your email configuration is working correctly!',
          help_text='Content of the test email'
        ) }}
        
        <div style="margin-top: var(--space-4);">
          {{ ui.button('Send Test Email', variant='success', type='submit') }}
        </div>
        
      </form>
    </div>
  </div>

  <!-- Settings History Link -->
  <div style="margin-top: var(--space-6); text-align: center;">
    <a href="{{ url_for('admin.settings_history') }}" class="btn btn--secondary">
      View Settings History
    </a>
  </div>

</div>

<script>
function setGmailConfig() {
  document.querySelector('[name="smtp_host"]').value = 'smtp.gmail.com';
  document.querySelector('[name="smtp_port"]').value = '587';
  document.querySelector('[name="smtp_use_tls"]').checked = true;
  document.querySelector('[name="smtp_use_ssl"]').checked = false;
  document.querySelector('[name="smtp_skip_auth"]').checked = false;
  alert('Gmail configuration applied. IMPORTANT: If you have 2FA enabled, use an App Password instead of your regular password. Create one at: https://support.google.com/accounts/answer/185833');
}

function setOutlookConfig() {
  document.querySelector('[name="smtp_host"]').value = 'smtp-mail.outlook.com';
  document.querySelector('[name="smtp_port"]').value = '587';
  document.querySelector('[name="smtp_use_tls"]').checked = true;
  document.querySelector('[name="smtp_use_ssl"]').checked = false;
  document.querySelector('[name="smtp_skip_auth"]').checked = false;
  alert('Outlook configuration applied. If you have 2FA enabled, use an App Password instead of your regular password.');
}
</script>

{% endblock %}
