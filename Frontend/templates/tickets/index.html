{% extends "base.html" %}

{% block title %}Support Tickets{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/tickets-enhanced.css') }}">
{% endblock %}

{% block body %}
<div class="tickets-container">
    <!-- Page Header -->
    <div class="tickets-header">
        <div class="tickets-header__title">
            <div class="tickets-header__icon">
                <i class="fas fa-ticket-alt"></i>
            </div>
            <div class="tickets-header__text">
                <h1>Support Tickets</h1>
                <p class="tickets-header__subtitle">Manage and track support requests</p>
            </div>
        </div>
        <div class="tickets-header__actions">
            {% if current_user.role != 'officer' %}
            <a href="{{ url_for('tickets.create') }}" class="btn-enhanced btn-enhanced--primary">
                <i class="fas fa-plus"></i>
                <span>Submit New Ticket</span>
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert-container" role="alert" aria-live="polite" style="margin-bottom: 2rem;">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Filter Panel -->
    <div class="filter-panel">
        <div class="filter-panel__header">
            <h2 class="filter-panel__title">
                <span class="filter-panel__title-icon">
                    <i class="fas fa-filter"></i>
                </span>
                Filters & Search
            </h2>
            <button class="filter-panel__toggle" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
                <i class="fas fa-sliders-h"></i>
                <span>Toggle Filters</span>
            </button>
        </div>
        <div class="collapse show" id="filtersCollapse">
            <div class="filter-panel__body">
                <form method="GET" action="{{ url_for('tickets.index') }}" id="filterForm">
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="search" class="filter-label">
                                <i class="fas fa-search"></i>
                                Search
                            </label>
                            <input type="text" class="filter-input" id="search" name="search" 
                                   value="{{ request.args.get('search', '') }}"
                                   placeholder="Search by title or description...">
                        </div>
                        <div class="filter-group">
                            <label for="status_filter" class="filter-label">
                                <i class="fas fa-info-circle"></i>
                                Status
                            </label>
                            <select class="filter-select" id="status_filter" name="status">
                                <option value="">All Status</option>
                                <option value="open" {{ 'selected' if request.args.get('status') == 'open' }}>Open</option>
                                <option value="in_progress" {{ 'selected' if request.args.get('status') == 'in_progress' }}>In Progress</option>
                                <option value="resolved" {{ 'selected' if request.args.get('status') == 'resolved' }}>Resolved</option>
                                <option value="closed" {{ 'selected' if request.args.get('status') == 'closed' }}>Closed</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="category_filter" class="filter-label">
                                <i class="fas fa-tags"></i>
                                Category
                            </label>
                            <select class="filter-select" id="category_filter" name="category">
                                <option value="">All Categories</option>
                                <option value="general" {{ 'selected' if request.args.get('category') == 'general' }}>General</option>
                                <option value="suggestion" {{ 'selected' if request.args.get('category') == 'suggestion' }}>Suggestion</option>
                                <option value="problem" {{ 'selected' if request.args.get('category') == 'problem' }}>Problem</option>
                                <option value="bug" {{ 'selected' if request.args.get('category') == 'bug' }}>Bug</option>
                                <option value="feature_request" {{ 'selected' if request.args.get('category') == 'feature_request' }}>Feature</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="priority_filter" class="filter-label">
                                <i class="fas fa-exclamation-triangle"></i>
                                Priority
                            </label>
                            <select class="filter-select" id="priority_filter" name="priority">
                                <option value="">All Priorities</option>
                                <option value="low" {{ 'selected' if request.args.get('priority') == 'low' }}>Low</option>
                                <option value="normal" {{ 'selected' if request.args.get('priority') == 'normal' }}>Normal</option>
                                <option value="high" {{ 'selected' if request.args.get('priority') == 'high' }}>High</option>
                                <option value="urgent" {{ 'selected' if request.args.get('priority') == 'urgent' }}>Urgent</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <a href="{{ url_for('tickets.index') }}" class="btn-enhanced btn-enhanced--secondary btn-enhanced--sm">
                            <i class="fas fa-times"></i>
                            <span>Clear</span>
                        </a>
                        <button type="submit" class="btn-enhanced btn-enhanced--primary btn-enhanced--sm">
                            <i class="fas fa-search"></i>
                            <span>Apply Filters</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tickets Table -->
    <div class="tickets-table-container">
        <div class="tickets-table-header">
            <h3 class="tickets-table-title">
                <i class="fas fa-list"></i> All Tickets
            </h3>
            {% if tickets %}
            <div class="tickets-table-info">
                <span>Showing {{ pagination.start_ticket }}-{{ pagination.end_ticket }} of {{ pagination.total_tickets }} ticket{{ 's' if pagination.total_tickets != 1 else '' }}</span>
            </div>
            {% endif %}
        </div>

        <div class="tickets-table-wrapper">
            {% if tickets %}
                            <!-- Bulk Actions -->
                            <div class="mb-3 p-3 bg-light rounded bulk-actions-hidden" id="bulkActions">
                                <form method="POST" action="{{ url_for('tickets.bulk_update') }}" id="bulkForm">
                                    <div class="row align-items-center">
                                        <div class="col-md-3">
                                            <strong id="selectedCount">0 tickets selected</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="bulkActionSelect" class="visually-hidden">Bulk Action</label>
                                            <select class="form-select form-select-sm" name="bulk_action" id="bulkActionSelect">
                                                <option value="">Choose action...</option>
                                                <option value="status_resolved">Mark as Resolved</option>
                                                <option value="status_in_progress">Mark as In Progress</option>
                                                <option value="status_open">Mark as Open</option>
                                                <option value="assign_me">Assign to Me</option>
                                                <option value="assign_officer">Assign to Officer</option>
                                                <option value="unassign">Unassign</option>
                                                <option value="delete">Delete Selected</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 assign-select-hidden" id="assignSelectDiv">
                                            <label for="assignSelect" class="visually-hidden">Assign To Officer</label>
                                            <select class="form-select form-select-sm" name="assign_to" id="assignSelect">
                                                <option value="">Select Officer...</option>
                                                {% for officer in officers %}
                                                <option value="{{ officer.id }}">{{ officer.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="submit" class="btn btn-primary btn-sm" id="bulkSubmitBtn" disabled>
                                                <i class="fas fa-check"></i> Apply Action
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="clearSelection()">
                                                <i class="fas fa-times"></i> Clear
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            {% endif %}

                            <table class="tickets-table">
                                <thead>
                                    <tr>
                                        {% if current_user.role == 'officer' %}
                                        <th width="40">
                                            <input type="checkbox" class="form-check-input" id="selectAll" title="Select all tickets">
                                        </th>
                                        {% endif %}
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Category</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Submitted</th>
                                        {% if current_user.role == 'officer' %}
                                        <th>Submitter</th>
                                        <th>Assigned To</th>
                                        {% endif %}
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ticket in tickets %}
                                    <tr class="ticket-row" data-ticket-id="{{ ticket.id }}">
                                        {% if current_user.role == 'officer' %}
                                        <td>
                                            <input type="checkbox" class="form-check-input ticket-checkbox" name="ticket_ids" value="{{ ticket.id }}" form="bulkForm" title="Select ticket {{ ticket.id.split('_')[1] }}">
                                        </td>
                                        {% endif %}
                                        <td><code class="text-muted">{{ ticket.id.split('_')[1] }}</code></td>
                                        <td>
                                            <a href="{{ url_for('tickets.view', ticket_id=ticket.id) }}" class="text-decoration-none fw-semibold">
                                                {{ ticket.title }}
                                            </a>
                                            {% if ticket.responses %}
                                            <br><small class="text-muted">{{ ticket.responses|length }} response{{ 's' if ticket.responses|length != 1 else '' }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ ticket.category_display }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if ticket.priority == 'low' else 'warning' if ticket.priority == 'normal' else 'danger' }}">
                                                {{ ticket.priority_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'primary' if ticket.status == 'open' else 'info' if ticket.status == 'in_progress' else 'success' if ticket.status == 'resolved' else 'secondary' }}">
                                                {{ ticket.status_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span title="{{ ticket.created_at.strftime('%Y-%m-%d %H:%M:%S') }}">
                                                {{ ticket.created_at.strftime('%Y-%m-%d') }}
                                            </span>
                                            {% if ticket.updated_at and ticket.updated_at != ticket.created_at %}
                                            <br><small class="text-muted">Updated {{ ticket.updated_at.strftime('%Y-%m-%d') }}</small>
                                            {% endif %}
                                        </td>
                                        {% if current_user.role == 'officer' %}
                                        <td>{{ ticket.submitter.name if ticket.submitter else 'Unknown' }}</td>
                                        <td>{{ ticket.assigned_officer.name if ticket.assigned_officer else '<em class="text-muted">Unassigned</em>'|safe }}</td>
                                        {% endif %}
                                        <td>
                                            <a href="{{ url_for('tickets.view', ticket_id=ticket.id) }}" class="btn btn-sm btn-outline-primary" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if pagination.total_pages > 1 %}
                        <nav aria-label="Ticket pagination" class="mt-4">
                            <ul class="pagination justify-content-center">
                                {% if pagination.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('tickets.index', page=pagination.prev_page, search=request.args.get('search'), status=request.args.get('status'), category=request.args.get('category'), priority=request.args.get('priority'), per_page=pagination.per_page) }}">
                                        <i class="fas fa-chevron-left"></i> Previous
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-chevron-left"></i> Previous</span>
                                </li>
                                {% endif %}
                                {% for page_num in pagination.pages %}
                                <li class="page-item {{ 'active' if page_num == pagination.page }}">
                                    <a class="page-link" href="{{ url_for('tickets.index', page=page_num, search=request.args.get('search'), status=request.args.get('status'), category=request.args.get('category'), priority=request.args.get('priority'), per_page=pagination.per_page) }}">
                                        {{ page_num }}
                                    </a>
                                </li>
                                {% endfor %}
                                {% if pagination.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('tickets.index', page=pagination.next_page, search=request.args.get('search'), status=request.args.get('status'), category=request.args.get('category'), priority=request.args.get('priority'), per_page=pagination.per_page) }}">
                                        Next <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Next <i class="fas fa-chevron-right"></i></span>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No tickets found</h4>
                            <p class="text-muted">
                                {% if request.args %}
                                No tickets match your current filters. Try adjusting your search criteria.
                                {% else %}
                                {% if current_user.role == 'officer' %}
                                No tickets have been submitted yet.
                                {% else %}
                                You haven't submitted any tickets yet.
                                {% endif %}
                                {% endif %}
                            </p>
                            {% if not request.args %}
                            {% if current_user.role != 'officer' %}
                            <a href="{{ url_for('tickets.create') }}" class="btn btn-primary">
                                Submit Your First Ticket
                            </a>
                            {% endif %}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const searchInput = document.getElementById('search');

    // Auto-submit form when filters change (with debounce for search)
    let searchTimeout;
    document.querySelectorAll('#status_filter, #category_filter, #priority_filter').forEach(select => {
        select.addEventListener('change', function() {
            filterForm.submit();
        });
    });

    // Debounced search
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterForm.submit();
        }, 500);
    });

    // Clear search on Escape key
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            searchInput.value = '';
            filterForm.submit();
        }
    });

    // Handle per-page selector
    const perPageSelect = document.getElementById('perPageSelect');
    if (perPageSelect) {
        perPageSelect.addEventListener('change', function() {
            // Add per_page to form and submit
            const perPageInput = filterForm.querySelector('input[name="per_page"]');
            if (perPageInput) {
                perPageInput.value = perPageSelect.value;
            } else {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'per_page';
                input.value = perPageSelect.value;
                filterForm.appendChild(input);
            }
            filterForm.submit();
        });
    }

    // Highlight search terms in results
    const searchTerm = searchInput.value.trim();
    if (searchTerm) {
        highlightSearchTerms(searchTerm);
    }

    function highlightSearchTerms(term) {
        const ticketRows = document.querySelectorAll('.ticket-row');
        ticketRows.forEach(row => {
            const titleCell = row.querySelector('td:nth-child(2) a');
            if (titleCell) {
                const titleText = titleCell.textContent;
                const highlightedTitle = titleText.replace(
                    new RegExp(`(${term})`, 'gi'),
                    '<mark>$1</mark>'
                );
                titleCell.innerHTML = highlightedTitle;
            }
        });
    }

    // Add loading state to filter form
    filterForm.addEventListener('submit', function() {
        const submitBtn = filterForm.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Filtering...';
        }
    });

    // Bulk operations functionality
    {% if current_user.role == 'officer' %}
    const selectAllCheckbox = document.getElementById('selectAll');
    const ticketCheckboxes = document.querySelectorAll('.ticket-checkbox');
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    const bulkActionSelect = document.getElementById('bulkActionSelect');
    const assignSelectDiv = document.getElementById('assignSelectDiv');
    const bulkSubmitBtn = document.getElementById('bulkSubmitBtn');

    function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('.ticket-checkbox:checked');
        const count = checkedBoxes.length;

        if (count > 0) {
            bulkActions.classList.remove('bulk-actions-hidden');
            selectedCount.textContent = `${count} ticket${count !== 1 ? 's' : ''} selected`;
            bulkSubmitBtn.disabled = false;
        } else {
            bulkActions.classList.add('bulk-actions-hidden');
            bulkSubmitBtn.disabled = true;
        }
    }

    function clearSelection() {
        ticketCheckboxes.forEach(cb => cb.checked = false);
        selectAllCheckbox.checked = false;
        updateBulkActions();
    }

    // Handle select all checkbox
    selectAllCheckbox.addEventListener('change', function() {
        ticketCheckboxes.forEach(cb => cb.checked = this.checked);
        updateBulkActions();
    });

    // Handle individual checkboxes
    ticketCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            const allChecked = Array.from(ticketCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(ticketCheckboxes).some(cb => cb.checked);

            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
            updateBulkActions();
        });
    });

    // Handle bulk action selection
    bulkActionSelect.addEventListener('change', function() {
        const action = this.value;
        if (action === 'assign_officer') {
            assignSelectDiv.classList.remove('assign-select-hidden');
        } else {
            assignSelectDiv.classList.add('assign-select-hidden');
        }

        // Add confirmation for delete action
        if (action === 'delete') {
            bulkSubmitBtn.innerHTML = '<i class="fas fa-trash"></i> Delete Selected';
            bulkSubmitBtn.className = 'btn btn-danger btn-sm';
        } else {
            bulkSubmitBtn.innerHTML = '<i class="fas fa-check"></i> Apply Action';
            bulkSubmitBtn.className = 'btn btn-primary btn-sm';
        }
    });

    // Add confirmation for bulk delete
    document.getElementById('bulkForm').addEventListener('submit', function(e) {
        if (bulkActionSelect.value === 'delete') {
            const count = document.querySelectorAll('.ticket-checkbox:checked').length;
            if (!confirm(`Are you sure you want to delete ${count} ticket${count !== 1 ? 's' : ''}? This action cannot be undone.`)) {
                e.preventDefault();
                return false;
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}