%% Detailed flowchart for AUIB Volunteer Management System (VMS)
%% Comprehensive Mermaid diagram (docs/flowchart.mmd)
%% This version explicitly shows component responsibilities, data flows, auth checks, error handling, and admin operations.

flowchart TB
  %% Top-level components and their relationships
  subgraph WebApp[Flask Web App - components]
    direction TB
  App["App Factory\ncreate_app\nconfigures DB, Mail, Blueprints, Login"]
  AuthBP["Blueprint: auth\nregister, login, forgot, reset\nsession and flask-login"]
  OfficerBP["Blueprint: officer\nevent CRUD, approvals, reports"]
  AdminBP["Blueprint: admin\nsettings, users, email logs"]
  LogBP["Blueprint: log\nJWT based per-volunteer logging links\ncreate/stop timelogs"]
  EmailModule["vms.email\nmail adapter: Flask-Mailman optional; smtp fallback"]
  DBWrapper["vms.db - SQLAlchemy\nsession factory, migrations helper"]
    App --> AuthBP
    App --> OfficerBP
    App --> AdminBP
    App --> LogBP
    App --> EmailModule
    App --> DBWrapper
  end

  %% Bulk submission: club leader uploads file -> parser -> DB entries -> officer approvals
  subgraph BulkSub[Bulk Submission Flow]
    direction TB
    ClubLeaderUI["Club Leader UI\nupload .csv/.xlsx file"]
    Parser["Upload Parser\n(pandas: read_csv/read_excel)\nvalidate columns: name,email,hours,role\nAUIB domain enforcement"]
    BulkModel["DB: BulkSubmission\n(id, club_id, submitted_by, created_at, filename)"]
    EntryModel["DB: BulkSubmissionEntry\n(id, bulk_id, name, email, hours, role, status, rejection_reason)"]
    OfficerQueue["Officer Review UI\nlist submissions and per-entry rows\nselect approve/reject"]
  MailQueue["Mail Queue / Worker\n(send notifications on reject/approve if configured)"]

    OfficerBP --> ClubLeaderUI
    ClubLeaderUI --> Parser
    Parser -->|create BulkSubmission & entries| BulkModel
    Parser --> EntryModel
    BulkModel --> EntryModel
    EntryModel --> OfficerQueue
    OfficerQueue -->|approve entry| EntryModel
    OfficerQueue -->|reject entry| EntryModel
    OfficerQueue -->|enqueue notifications| MailQueue
    MailQueue --> EmailModule
    MailQueue --> SQL["Primary DB - models: User, Event, TimeLog, EmailLog, Setting, SettingAudit"]
  end

  %% Persistence
  subgraph Persistence[Database - SQLAlchemy]
    direction LR
    SQL["Primary DB - models: User, Event, TimeLog, EmailLog, Setting, SettingAudit"]
  end

  %% Mail infra and fallback
  subgraph MailInfra[Mail Infrastructure]
    direction TB
  MailExt["Flask-Mailman optional\nhigh-level API, queued send"]
  SMTP["smtplib fallback\nblocking send, retriable logic in vms.email"]
  MailHog["MailHog dev\nSMTP 127.0.0.1:1025 Web 8025"]
    MailExt --- EmailModule
    SMTP --- EmailModule
    MailHog --- SMTP
  end

  %% Event creation -> per-volunteer token generation -> email pipeline
  OfficerBP -->|POST create_event| OfficerCreate["Create Event\nnormalize CSV, dedupe emails"]
  OfficerCreate -->|save Event| SQL
  OfficerCreate -->|for each volunteer| MakeJWT["make_logging_jwt: generate token with expiry and event claims"]
  MakeJWT -->|render per-volunteer email| RenderEmail["render email_link template\nincludes link to /log/token"]
  RenderEmail -->|enqueue/send| EmailModule
  EmailModule -->|write status| SQL_EmailLog["EmailLog: QUEUED -> SENT / FAILED (with error)"]

  %% Email send retry and fallback (explicit)
  EmailModule -->|try mail extension| MailExt
  EmailModule -->|fallback| SMTP
  SMTP -->|dev capture| MailHog
  EmailModule -->|on failure| RetryLogic["retry/backoff or record failure & notify admin"]
  RetryLogic --> SQL_EmailLog

  %% Volunteer logging via JWT link (happy + error paths)
  Volunteer["Volunteer (email link) clicks token"] -->|GET log endpoint| LogBP
  LogBP -->|decode token & validate| DecodeJWT["decode_logging_jwt - verify signature and expiry and event exists"]
  DecodeJWT -->|valid| CreateTimeLog["create TimeLog PENDING; associate user if known"]
  DecodeJWT -->|expired| TokenExpired["show token expired; suggest requesting new link"]
  DecodeJWT -->|invalid| TokenInvalid["show invalid link error"]
  CreateTimeLog --> SQL["TimeLog (PENDING)"]
  CreateTimeLog -->|POST /log/stop| UpdateTime["complete TimeLog: set end, calculate hours, status=COMPLETED"]
  UpdateTime --> SQL

  %% Volunteer self-service: register/login/dashboard & signup flows
  Visitor["Visitor not logged in"] -->|POST register| AuthBP:Register["register - creates User with role student"]
  AuthBP:Register -->|login_user| AuthBP:Login
  Visitor -->|POST login| AuthBP:Login["login - authenticate and create session"]
  AuthBP:Login -->|on success| Dashboard["/volunteer dashboard - shows active/upcoming/past events and signup buttons"]
  Dashboard -->|POST /volunteer/signup| AuthBP:Signup["create TimeLog (SIGNED_UP) or mark signup flag"]
  AuthBP:Signup --> SQL

  %% Officer approval & reporting
  OfficerBP -->|view pending timelogs| PendingView["Officer approval UI: filter by event/club/period"]
  PendingView -->|approve| ApproveAction["mark TimeLog = APPROVED (creates hours credit)"]
  PendingView -->|reject| RejectAction["mark TimeLog = REJECTED (store reason)"]
  ApproveAction --> SQL
  RejectAction --> SQL
  PendingView -->|export| Reports["reports & CSV export (by date/event/user)"]

  %% Admin UI: settings, email logs, users & audit
  AdminBP -->|GET/POST settings| SettingsUI["Admin settings UI\n(edit SMTP, MAIL_DEFAULT_SENDER)"]
  SettingsUI -->|save| SQL_Setting["Setting rows"]
  SettingsUI -->|audit| SettingAudit["SettingAudit (key, old_value, new_value, changed_by, at)"]
  AdminBP -->|view email logs| EmailLogsUI["Admin Email Logs UI\n(filters, pagination, inspect errors)"]
  EmailLogsUI --> SQL_EmailLog
  AdminBP -->|manage users| UsersUI["Users CRUD, promote/demote (admin-only)"]
  UsersUI --> SQL

  %% Password reset flow (explicit)
  AuthBP -->|GET /forgot| ForgotForm["forgot password form"]
  ForgotForm -->|POST email| GenerateReset["create JWT pwreset token (short expiry)"]
  GenerateReset --> RenderResetEmail["render: email_reset.html + link /auth/reset/<token>"]
  RenderResetEmail --> EmailModule
  Volunteer -->|click reset link| ResetRoute["/auth/reset/<token>"]
  ResetRoute -->|verify token| ResetValidate["verify JWT, expiry, user exists"]
  ResetValidate -->|ok| ResetApply["set new password -> hash -> SQL User.password_hash updated"]

  %% Local dev & tests
  subgraph DevTests[Local tests & QA]
    direction TB
    ManualMailHog["Run MailHog (dev) to capture outgoing SMTP"]
    UnitTests["pytest unit tests (email, models, auth)"]
    ManualMailHog --> EmailModule
    UnitTests --> EmailModule
    UnitTests --> SQL
  end

  %% Cross-links and metadata
  SQL_EmailLog --> SQL
  SQL --> SettingAudit

  classDef infra fill:#fef3c7,stroke:#f59e0b
  classDef core fill:#ecfeff,stroke:#06b6d4
  class App,AuthBP,OfficerBP,AdminBP,LogBP,EmailModule core
  class MailInfra,MailExt,SMTP,MailHog infra
  class SQL,SQL_EmailLog,SettingAudit core

  %% Notes for maintainers
  subgraph Notes[Notes]
    direction TB
    N1([JWT tokens are stateless â€” if you need single-use tokens, store references in the DB and mark used=true on first use.])
    N2([Email sending: prefer queued/async using Flask-Mailman or a task queue; fallback to SMTP for simple installs.])
    N3([Admin UI: changing SMTP settings is audited via SettingAudit. Consider validating SMTP connection before saving.])
  end

  Notes --> App
  Notes --> EmailModule
